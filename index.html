<script>
    let voices = [];
    let voicesLoaded = false;

    function loadVoices(retry = 5) {
        voices = window.speechSynthesis.getVoices();
        const voiceSelect = document.getElementById("voiceSelect");

        if (voices.length === 0 && retry > 0) {
            setTimeout(() => loadVoices(retry - 1), 500); // 500msごとに再試行
            return;
        }

        voiceSelect.innerHTML = '';

        // **日本語音声のみ取得**
        const japaneseVoices = voices.filter(voice => voice.lang === 'ja-JP');

        if (japaneseVoices.length === 0) {
            const option = document.createElement("option");
            option.textContent = "日本語対応の音声が見つかりません";
            option.disabled = true;
            voiceSelect.appendChild(option);
            return;
        }

        japaneseVoices.forEach(voice => {
            const option = document.createElement("option");
            option.textContent = voice.name;
            option.value = voice.name;
            voiceSelect.appendChild(option);
        });

        // **Kyoko を優先的に選択**
        const kyokoVoice = japaneseVoices.find(voice => voice.name.includes("Kyoko"));
        if (kyokoVoice) {
            voiceSelect.value = kyokoVoice.name;
        } else {
            voiceSelect.value = japaneseVoices[0].name; // Kyokoがなければ最初の日本語音声を選択
        }

        voicesLoaded = true;
    }

    function speakText() {
        const text = document.getElementById("text").value;
        if (text === '') {
            alert("テキストを入力してください");
            return;
        }

        if (!voicesLoaded) {
            alert("音声データの読み込みが完了していません。しばらくしてから再試行してください。");
            return;
        }

        const speech = new SpeechSynthesisUtterance(text);
        const selectedVoiceName = document.getElementById("voiceSelect").value;
        const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
        speech.voice = selectedVoice;

        speech.lang = 'ja-JP';
        speech.rate = 1;
        speech.volume = 1;
        speech.pitch = 1.2;

        window.speechSynthesis.speak(speech);
    }

    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();
</script>
